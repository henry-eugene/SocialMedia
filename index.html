<html>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBNSzFD9R_JP_UNlF7pbpOr3d6h0XXW7hg",
    authDomain: "social-media-69e85.firebaseapp.com",
    databaseURL: "https://social-media-69e85.firebaseio.com",
    projectId: "social-media-69e85",
    storageBucket: "social-media-69e85.appspot.com",
    messagingSenderId: "837818397370"
  };
  firebase.initializeApp(config);
 
    // Check to see if you are logged in
        firebase.auth().onAuthStateChanged(function(user) {
            if (user == null) {
                myphotodiv = document.getElementById("invis");
                myphotodiv.style.display="none";
                signinbutton = document.getElementById("signin");
                signinbutton.style.display="inline";
                return;
            } else {
                userId = user.uid;
                name = user.displayName;
                imageUrl = user.photoURL;
                email = user.email;
                signinbutton = document.getElementById("signin");
                signinbutton.style.display="none";
                myphotodiv = document.getElementById("invis");
                myphotodiv.style.display="inline";
                    
                // write user data to users
                writeUserData(userId, name, email, imageUrl);
                
                // write data to document
               
               myphotodiv = document.getElementById("myphoto");
               myphotodiv.innerHTML = "<img src='" + imageUrl + "'style='max-height:26px; border-radius: 50%; vertical-align: middle;display:inline-block; padding-bottom: 0px; z-index:-1;'/>";

                firebase.database().ref('/tweets').once('value').then(function(snapshot) {
                    var data = (snapshot.val());
                    if (data == null) {
                      console.log("No data found at /tweets/" + userId);  
                    } else {
                        
                      firebase.database().ref('/users').once('value').then(function(snapshot) { 
                        var userdata = (snapshot.val());
                        if (userdata != null) {
                           dataarray = [data,userdata];
                           console.log(dataarray);
                           updatetweets(dataarray); 
                        }
                      });
                      //console.log(data)
                      //updatetweets(data);
                    }
                });
            } // end user null check
        }); // end check auth state
        
        function encodeImageFileAsURL() {

            var filesSelected = document.getElementById("inputFileToLoad").files;
            if (filesSelected.length > 0) {
                var fileToLoad = filesSelected[0];
                var fileReader = new FileReader();
                fileReader.onload = function(fileLoadedEvent) {
                    var srcData = fileLoadedEvent.target.result; // <--- data: base64
                    //var newImage = document.createElement('img');
                    //newImage.src = srcData;
                    //document.getElementById("imgTest").innerHTML = newImage.outerHTML;
                    document.getElementById("imgTest").innerHTML = srcData;
                    //console.log("Converted Base64 version is: " + document.getElementById("imgTest").innerHTML);
                    console.log(srcData);
                }
                fileReader.readAsDataURL(fileToLoad);
            }
        } // end function
        
        // write user data
        function writeUserData(userId, name, email, imageUrl) {
            firebase.database().ref('users/' + userId).set({
                username: name,
                email: email,
                profile_picture : imageUrl
            });
        }
        function myFunction(n) {
          var popup = document.getElementById("myPopup " + n);
          popup.classList.toggle("show");
            console.log("hi");
        ;}
        function updatetweets(data) {
            //var mylist = "<ul>";
            var mytab = "<table style='width: 100%;'>";
            users = data[1]; // put on top, because changed data - not good coding change later
            data = data[0];
            
            for (var u in data) {
                for (var t in data[u]) {
                    mytab = mytab + "<tr>";
                    var date = new Date(data[u][t].time);
                    var epoch = date.getTime();
                    var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
                    var time = date.toString();
                    var time2;
                    var AM = "A.M";
                    var today = new Date();
                    var dd = date.getDate();
                    var mm = date.getMonth();
                    var yyyy = date.getFullYear();
                    var h = date.getHours();
                    var min = date.getMinutes();
                    if(h > 12) {
                        h = h - 12;
                        AM = "P.M";
                    }
                    if(min < 10) {
                        min = "0" + min;
                    }
                    time2 = ("Posted " + months[mm] + " " + dd + ", " + yyyy + " at " + h + ":" + min + " " + AM + ".").toString();
                    
                    var diff =  today.getTime() - date.getTime(); // this is a time in milliseconds
                    
    var diffdate = new Date(diff);
    var minutes = Math.floor(diffdate / 60000);
    var hours = Math.floor(minutes / 60);
                    minutes = minutes % 60;
    var days = Math.floor(hours / 24);
                    hours = hours % 24;
    var years = Math.floor(days / 365);
                    days = days % 365;
    var count = 0;
    var time = "Posted ";
                    
    var names = [" years", " days", " hours", " minutes"];
    var singlenames = [" year", " day", " hour", " minute"];
            var totals = [years,  days, hours, minutes];
                    for(var i = 0; i < 4; i++) {
                        if(totals[i]!= 0) {
                            if(totals[i] == 1) {
                                time = time + totals[i] + singlenames[i];
                                break;
                            }
                            else {
                                 time = time + totals[i] + names[i];
                                break;
                            }
                        }
                        if(i != 3 && totals[i]!= 0) {
                            time = time + ", ";
                        }
                    }
                   
                    
                        time += " ago.".toString();
                    
                    if(minutes == 0 && hours == 0 && days == 0) {
                        time = "Posted just now.";
                    }
                    
                    

                    if (data[u][t].img != "") {
                        mytab = mytab + "<td><img src='" + users[u].profile_picture + "' width='50px' style='border-radius:50%; vertical-align: middle;''> "+ " " + users[u].username+ "</td>";   
                        mytab = mytab  + "<td class='popup' style='float:right;' onclick='myFunction(" + epoch + ")'> " + time +  "<span class='popuptext' id='myPopup " + epoch + "'>" + time2 + "</span></td>";
                        mytab = mytab + "</tr><tr>";
                        mytab = mytab + "<td><img src='" + data[u][t].img + "' width='300px'></td>";
                        mytab = mytab + "<td class = 'post'>" + data[u][t].tweet + "</td>";
                    } else {
                         mytab = mytab + "<td><img src='" + users[u].profile_picture + "' width='50px' style='border-radius:50%;vertical-align: middle;'' >"+ " " + users[u].username+ "</td>";
                        mytab = mytab  + "<td class='popup' style='float:right;' onclick='myFunction(" + epoch + ")'> " + time + "<span class='popuptext' id='myPopup " + epoch + "'>" + time2 + "</span></td>";
                        mytab = mytab + "</tr><tr>";
                        mytab = mytab + "</tr><tr>";
                         mytab = mytab + "<td class = 'post'>" + data[u][t].tweet + "</td>";
                        
                    } 
                    mytab = mytab + "</tr>";
                }   
            }
            //mylist = mylist + "</ul>";
            mytab = mytab + "</table>"
            var mytdiv = document.getElementById("mytweets");
            //mytdiv.innerHTML = mylist;
            mytdiv.innerHTML = mytab;
        }
        
        // write tweets to firebase
        function tweet() {
            
            var twitdoc = document.getElementById("twit");
            var twitimg = document.getElementById("imgTest");
            var nameValue = twitdoc.value;
            var imgValue = twitimg.innerHTML;
            var js_time = Date.now();
            var tweetid = firebase.database().ref('tweets/' + userId + "/").push({tweet: nameValue, time: js_time, img: imgValue});
            twitdoc.value = "";
            console.log("tweet written")
            
            firebase.database().ref('/tweets').once('value').then(function(snapshot) {
                    var data = (snapshot.val());
                    if (data == null) {
                      console.log("No data found at /tweets/" + userId);  
                    } else { 
                        firebase.database().ref('/users').once('value').then(function(snapshot) { 
                        var userdata = (snapshot.val());
                        if (userdata != null) {
                           dataarray = [data,userdata]
                           console.log(dataarray)
                           updatetweets(dataarray); 
                        }
                      });
                    }
                });
            
            
            
            // The unique key stored in tweetid is based on a timestamp, so list items will automatically be ordered chronologically. Because Firebase generates a unique key for each tweet, no write conflicts will occur if multiple users add a post at the same time. https://firebase.google.com/docs/database/admin/save-data
            
        }
        
        function signin() {
            console.log("Signing in");
            var provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithRedirect(provider).then(function(result) { 
                window.location.replace("fbtest.html");
            });
        }
        
        function signout() {
            console.log("Signing out");
            document.location.reload()
            firebase.auth().signOut().then(function() {
            });
        }
    
    
    </script>
    <style>   
        
        #form{
            font-size: 30px;
        }
         .custom-file-upload {
             display: inline-block;
             border: 1px solid deepskyblue; 
             font-family: 'Nunito', sans-serif;             
             border-radius: 10px;
             padding: 6px 12px;
             cursor: pointer;
             height: 30px;
             width: 61px;
             font-size: 12px;
             background-color: deepskyblue;
             text-align: center;
             margin-left: 120px;
            }
        input[type="file"] {
            display: none;
        }
        #submit{
            border-radius: 10px;
            border-color: deepskyblue;
            height: 45px;
            width: 87px;
            background-color: deepskyblue;
            font-family: 'Nunito', sans-serif;  
            font-size: 12px;
            margin-left: 120px;
            margin-bottom: 10px;
        }
        
        #twit {
           border-radius: 10px; 
           font-size: 20px;
           width: 95%;
           height: 20%;
        }
        
        body {
           padding: 0px;
            margin: 0px;
        }
        .topnav {
            font-family: "Fredoka One";
            overflow; hidden;
            background-color:deepskyblue;
            color: white;
            font-size: 30px;
            padding: 13px;
              font-family: 'Big John', sans-serif;

            
        }
        .topnav a {
            color: white;
            float: right;
           text-align: center;
            text-decoration: none;
            font-size: 18px;
            padding: 9px;
            height:100%;
            max-height: 20px;
            z-index: 5;
              font-family: 'Big John', sans-serif;

        }
       
        
        .topnav a:hover {
            background-color:white;
            color:deepskyblue;
        }
        .topnav a.active {
            background-color: white;
            color: deepskyblue;
        }
       
    /* Dropdown Button */
.dropbtn {
  background-color: deepskyblue;
  color: white;
  padding: 16px;
  font-size: 16px;
  border: none;
  cursor: pointer;

}
        

/* Dropdown button on hover & focus */
.dropbtn:hover, .dropbtn:focus {
  background-color: deepskyblue;
}

/* The container <div> - needed to position the dropdown content */
.dropdown {
    float: right;
  overflow: hidden;
  display: inline-block;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
  display: none;
  position: absolute;
    top: 51px;
  background-color: #f1f1f1;
  min-width: 80px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
  float: none;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #ddd}
        .dropdown:hover .dropdown-content {
            display: block;
        }

/* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
.show {display:block;}
        /* Create three equal columns that floats next to each other */
.column {
  float: left;
  padding: 5px;
    margin-top: 20px;
 
    font-family: "Fredoka One";
   
}

        .left {
            width: 25%;
            min-width: 250px;
        }
        .middle {
            width: 50%;
             border-style: solid;
            border-color: lightsteelblue;
            border-width: 2px;
            border-radius: 7px;
        }

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

/* Responsive layout - makes the three columns stack on top of each other instead of next to each other */
@media screen and (max-width: 1250px) {
  .column {
width: 90%;
      margin: 0 auto;
      float: none;
  }
}
    .popup {
  position: relative;
  display: inline-block;
  cursor: pointer;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
   border: 10px;
        margin: 10px;
}

/* The actual popup */
.popup .popuptext {
  visibility: hidden;
  width: 160px;
  background-color: deepskyblue;
  color: white;
  text-align: center;
  border-radius: 6px;
  padding: 8px 0;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -80px;
}

 /*Popup arrow */ 
.popup .popuptext::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: deepskyblue transparent transparent transparent;
}


        .popup .show {
            visibility: visible;
            -webkit-animation: fadeIn 1s;
            animation: fadeIn 1s;
        }

/* Add animation (fade in the popup) */
@-webkit-keyframes fadeIn {
  from {opacity: 0;} 
  to {opacity: 1;}
}

@keyframes fadeIn {
  from {opacity: 0;}
  to {opacity:1 ;}
}
        .post {
            height: 100px;
            min-height: 100px;
            
        }
        
    </style>
    <body>
        <div class="topnav">    
            <i class="fas fa-igloo"></i> Igloo  
            <a class="active" href="index.html">Home</a>
            <span id="invis">
                <span class="dropdown" >
                <a style="height:100px:" class="dropbtn" ><span id="myphoto" ></span> <i style="position:relative; bottom: 10px;" class="fa fa-caret-down"></i></a>
                <span id="myDropdown" class="dropdown-content">
                    <a href="profile.html">My Igloo</a>
                    <a onclick="signout()" href="signin.html">Sign Out</a>
                    <a href="settings.html">Settings</a>
                </span>
            </span>
               
            </span>
            <a href="draw.html"><i class="fas fa-plus-circle"></i></a>
         <a id="signin" onclick="signin()">Sign in</a>
   
    </div>
            
        <!-- Slideshow -->
             <div class="slideshow-container">
                 <div class="mySlides fade">
                  <div class="numbertext">1 / 3</div>
                  <img src="background.jpg" height="550px" width="500px" style="width:100%">
                  <div class="text">Soothing Sunset</div>
                </div>

                <div class="mySlides fade">
                  <div class="numbertext">2 / 3</div>
                  <img src="background2.jpeg" height="550px" width="500px" style="width:100%">
                  <div class="text">Icy Iceburg</div>
                </div>

                <div class="mySlides fade">
                  <div class="numbertext">3 / 3</div>
                  <img src="background3.jpg" height="550px" width="500px" style="width:100%">
                  <div class="text">Glancing Glaze</div>
                </div>

                </div>
                <br>
                <div style="text-align:center">
                  <span class="dot"></span> 
                  <span class="dot"></span> 
                  <span class="dot"></span> 
            </div>
            
            <!-- slideshow style -->
            <style>


                /* Slideshow container */
                .slideshow-container {
                  max-width: 1000px;
                  position: relative;
                  margin: auto;
                    margin-top: 20px;
                }

                /* Hide the images by default */
                .mySlides {
                  display: none;
                }

                /* On hover, add a black background color with a little bit see-through */
                .prev:hover, .next:hover {
                  background-color: rgba(0,0,0,0.8);
                }

                /* Caption text */
                .text {
                  color: #f2f2f2;
                  font-size: 15px;
                  padding: 8px 12px;
                  position: absolute;
                  bottom: 8px;
                  width: 100%;
                  text-align: center;
                }

                /* Number text (1/3 etc) */
                .numbertext {
                  color: #f2f2f2;
                  font-size: 12px;
                  padding: 8px 12px;
                  position: absolute;
                  top: 0;
                }
/* dsa
                /* The dots/bullets/indicators */
                .dot {
                  cursor: pointer;
                  height: 15px;
                  width: 15px;
                  margin: 0 2px;
                  background-color: #bbb;
                  border-radius: 50%;
                  display: inline-block;
                  transition: background-color 0.6s ease;
                }

                .active, .dot:hover {
                  background-color: #717171;
                }

                /* Fading animation */
                .fade {
                  -webkit-animation-name: fade;
                  -webkit-animation-duration: 1.5s;
                  animation-name: fade;
                  animation-duration: 1.5s;
                }

                @-webkit-keyframes fade {
                  from {opacity: .4} 
                  to {opacity: 1}
                }

                @keyframes fade {
                  from {opacity: .4} 
                  to {opacity: 1}
                }
            </style>
            
            <!-- Javascript of Slideshow -->
            <script>
             var slideIndex = 0;
                showSlides();

                function showSlides() {
                    var i;
                    var slides = document.getElementsByClassName("mySlides");
                    for (i = 0; i < slides.length; i++) {
                        slides[i].style.display = "none"; 
                        }
                    slideIndex++;
                    if (slideIndex > slides.length) {slideIndex = 1} 
                    slides[slideIndex-1].style.display = "block"; 
                    setTimeout(showSlides, 5000); // Change image every 2 seconds
                }         
            </script>
           
            
        <div class="row">
       <div class ="column left">
           
        <form id="form">
            Post Something!<br>
            <textarea id="twit" type="text" name="thetweet" cols="50" rows="15"></textarea>
        </form> 
        <button type="button" onclick="tweet()" id="submit">Submit</button>
    <br><label class="custom-file-upload"><input id="inputFileToLoad" type="file" onchange="encodeImageFileAsURL();" />Choose File</label>
            </div>
            <div class="column middle">
            
        <div id="imgTest" style="display:none;"></div>
    <div id="mytweets"></div>
                </div>
 </div>
    
    </body>

    
</html>
